<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Form Pengambilan Stok</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(135deg,#e9f5ff 0%, #f9fafb 100%);
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      margin: 0;
    }
    main.container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 90vh;
    }
    section {
      background: #fff;
      padding: 2.5rem 2rem 2rem 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(80,120,255,0.07), 0 2px 8px rgba(44,62,80,0.10);
      max-width: 410px;
      width: 100%;
      transition: box-shadow .18s;
      animation: fadein .6s;
    }
    section:hover {
      box-shadow: 0 12px 32px rgba(80,120,255,0.16), 0 4px 16px rgba(44,62,80,0.15);
    }
    @keyframes fadein { from { opacity: 0; transform:translateY(24px);} to {opacity:1; transform:none;} }

    .header-row {
      display: flex;
      align-items: center;
      gap: 1.2rem;
      margin-bottom: 1.1rem;
    }
    .header-row img {
      width: 54px;
      height: 54px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(80,120,255,0.09);
      background: #f2f8ff;
    }
    .header-row h2 {
      margin: 0 0 .22rem 0;
      font-weight: 800;
      letter-spacing: -0.5px;
      font-size: 1.35rem;
      color: #2c3e50;
    }
    .header-row h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 400;
      color: #677;
      opacity: 0.85;
    }
    form label {
      font-weight: 500;
      color: #447;
      margin-top: 1rem;
    }
    select, input[type="number"] {
      margin-bottom: 0.4rem;
    }
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .55rem .75rem;
      margin-top: .5rem;
      margin-bottom: .2rem;
    }
    .input-icon-group {
      position: relative;
    }
    .input-icon-group .material-symbols-rounded {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: #a1b4d0;
      font-size: 21px;
      pointer-events: none;
    }
    .input-icon-group input {
      padding-left: 2.1rem !important;
      font-weight: 500;
    }
    #totalHarga {
      font-weight: bold;
      margin: .8rem 0 1.2rem 0;
      font-size: 1.07rem;
      color: #126fa3;
      letter-spacing: 0.2px;
      transition: color .15s;
      background: #f5fcff;
      border-radius: 7px;
      padding: .35em 1em;
      display: inline-block;
    }
    button[type="submit"] {
      width: 100%;
      font-size: 1.08rem;
      font-weight: 600;
      background: linear-gradient(95deg,#1877ff 10%, #55c6ff 95%);
      color: white !important;
      border: none;
      border-radius: 8px;
      padding: .95em 0;
      box-shadow: 0 2px 16px #bae7ff56;
      transition: background .2s, box-shadow .18s, scale .09s;
      letter-spacing: 0.03em;
    }
    button[type="submit"]:hover {
      background: linear-gradient(85deg,#1370e7 5%, #15bae2 90%);
      scale:1.03;
      box-shadow: 0 4px 20px #b9e5ff92;
    }
    footer.container {
      margin-top: auto;
      padding: 2rem 0 .8rem 0;
      text-align: center;
      font-size: .9rem;
      opacity: .65;
      color: #364e6e;
    }
    @media (max-width: 500px) {
      main.container {
        min-height: 100vh;
        padding: 1rem 0;
      }
      section {
        max-width: 98vw;
        padding: 1.3rem 0.6rem 1.5rem 0.6rem;
      }
      .header-row h2 { font-size: 1.13rem; }
      #totalHarga { font-size: .98rem;}
      button[type="submit"] { font-size: .97rem;}
    }
    /* Modal Alert Animation */
    @keyframes pop {
      from { transform:scale(.92); opacity:0;}
      to   { transform:scale(1); opacity:1;}
    }
  </style>
</head>
<body>
  <main class="container">
    <section>
      <div class="header-row">
        <img src="image/logo_tabib.png" alt="Cayo Perico Logo">
        <div>
          <h2>Form Pengambilan Stok</h2>
          <h3>Isi data dengan benar biar pengurus nggak mumet üòÅ</h3>
        </div>
      </div>
      <form id="stockForm" autocomplete="off">
        <label for="nama">Nama Pengambil</label>
        <select id="nama" name="nama" required></select>
        <label for="penanggung">Penanggung Jawab</label>
        <select id="penanggung" name="penanggung" required></select>
        <label for="keterangan">Keterangan</label>
        <select id="keterangan" name="keterangan" required></select>
        <label>Jumlah Barang</label>
        <div class="input-grid">
          <div class="input-icon-group">
            <span class="material-symbols-rounded">spa</span>
            <input type="number" id="pegagan" name="Pegagan" placeholder="Pegagan (unit)" min="0">
          </div>
          <div class="input-icon-group">
            <span class="material-symbols-rounded">healing</span>
            <input type="number" id="perban" name="Perban" placeholder="Perban (unit)" min="0">
          </div>
          <div class="input-icon-group">
            <span class="material-symbols-rounded">medication</span>
            <input type="number" id="painkiller" name="Painkiller" placeholder="Painkiller (unit)" min="0">
          </div>
          <div class="input-icon-group">
            <span class="material-symbols-rounded">local_hospital</span>
            <input type="number" id="betadine" name="Betadine" placeholder="Betadine (unit)" min="0">
          </div>
          <div class="input-icon-group">
            <span class="material-symbols-rounded">science</span>
            <input type="number" id="zatbesi" name="Zat Besi" placeholder="Zat Besi (unit)" min="0">
          </div>
          <div class="input-icon-group">
            <span class="material-symbols-rounded">grass</span>
            <input type="number" id="sayurkol" name="Sayur Kol" placeholder="Sayur Kol (unit)" min="0">
          </div>
        </div>
        <div id="totalHarga">Total Harga: Rp 0</div>
        <label for="token">Token Akses Hari Ini</label>
        <input type="text" id="token" name="token" pattern="\d{4}" maxlength="4" placeholder="Masukkan token hari ini" required>
        <button type="submit">Sikat üöÄ</button>
      </form>
    </section>
  </main>

  <footer class="container">
    <small>Tabib Pulau ¬© Cayo Perico #IndoPride</small>
  </footer>
  
  <!-- MODAL ALERT -->
  <div id="customAlert" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(40,48,68,0.15); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; box-shadow:0 8px 32px rgba(44,62,80,0.18); padding:2.1rem 1.5rem 1.4rem 1.5rem; max-width:90vw; min-width:260px; text-align:center; animation:pop .27s;">
      <span id="modalIcon" style="font-size:2.5rem; display:block; margin-bottom:.5em; color:#1877ff;">&#10004;</span>
      <div class="font-weight-700" style="font-size:1.25rem; font-weight:700; color:#222; margin-bottom:0.2em;">Data berhasil direkap!</div>
      <div class="font-weight-normal" style="font-size:.97rem; color:#667; margin-bottom:.9em;">Pengambilan stok kamu sudah masuk sistem.<br>Terima kasih üôè</div>
      <button onclick="hideCustomAlert()" style="margin-top:.5em; background:linear-gradient(90deg,#1877ff 20%,#55c6ff 100%);color:white;font-weight:600;border:none;padding:.6em 1.7em;border-radius:8px;box-shadow:0 2px 14px #bce6ff54;cursor:pointer;">Sip!</button>
    </div>
  </div>
  <script>
const anggotaEndpoint = "https://v1.nocodeapi.com/sayheysob/google_sheets/iRofLAbBmXmbbbQy?tabId=Anggota%20Tabib";
const tokenEndpoint = "https://v1.nocodeapi.com/sayheysob/google_sheets/pExEanXyYErzsCpl?tabId=token";

const prices = {
  pegagan: 2500,
  perban: 4000,
  painkiller: 17500,
  betadine: 10000,
  zatbesi: 15000,
  sayurkol: 10000
};

function calculateTotal() {
  const getVal = id => parseInt(document.getElementById(id).value) || 0;
  const total =
    getVal("pegagan") * prices.pegagan +
    getVal("perban") * prices.perban +
    getVal("painkiller") * prices.painkiller +
    getVal("betadine") * prices.betadine +
    getVal("zatbesi") * prices.zatbesi +
    getVal("sayurkol") * prices.sayurkol;

  document.getElementById("totalHarga").textContent = "Total Harga: Rp " + total.toLocaleString("id-ID");
  return total;
}

document.querySelectorAll("input[type='number']").forEach(input => {
  input.addEventListener("input", calculateTotal);
});

// --- FUNGSI DROPDOWN (Anggota Tabib) ---
async function populateDropdowns() {
  try {
    const res = await fetch(anggotaEndpoint);
    const result = await res.json();
    const data = result.data;

    const namaOptions = [...new Set(data.map(row => row["ANGGOTA TABIB"]).filter(Boolean))];
    const penanggungOptions = [...new Set(data.map(row => row["PENGURUS"]).filter(Boolean))];
    const keteranganOptions = [...new Set(data.map(row => row["KETERANGAN"]).filter(Boolean))];

    const fillSelect = (id, options) => {
      const select = document.getElementById(id);
      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Pilih...";
      placeholder.disabled = true;
      placeholder.selected = true;
      select.appendChild(placeholder);
      options.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });
    };

    fillSelect("nama", namaOptions);
    fillSelect("penanggung", penanggungOptions);
    fillSelect("keterangan", keteranganOptions);
  } catch (error) {
    console.error("Gagal mengambil data anggota:", error);
  }
}
populateDropdowns();

// --- FUNGSI VALIDASI TOKEN ---
async function isTokenValid(token) {
  const res = await fetch(tokenEndpoint);
  const result = await res.json();
  const data = result.data;
  if (!data || !data[0]) return false;
  const tokenSheet = data[0].TOKEN;
  return token === tokenSheet;
}

// --- SUBMIT FORM ---
const submitBtn = document.querySelector('button[type="submit"]');
document.getElementById("stockForm").addEventListener("submit", async function(event) {
  event.preventDefault();

  submitBtn.disabled = true;
  submitBtn.innerHTML = `<span class="material-symbols-rounded" style="vertical-align:middle;font-size:1.2em;">hourglass_top</span> Sabar bos, loading...`;

  const tokenVal = document.getElementById("token").value.trim();

  // --- CEK TOKEN ---
if (!await isTokenValid(tokenVal)) {
  document.getElementById("modalIcon").textContent = "‚ùå";
  document.getElementById("modalIcon").style.color = "#ff4848";
  document.querySelector("#customAlert .font-weight-700").textContent = "Token salah!";
  document.querySelector("#customAlert .font-weight-normal").textContent = "Coba tanyakan ke pengurus!";
  showCustomAlert();
  submitBtn.disabled = false;
  submitBtn.innerHTML = "Sikat üöÄ";
  return;
}

  const getVal = id => parseInt(document.getElementById(id).value) || 0;
  const getText = id => document.getElementById(id).value || "-";

  const total = calculateTotal();
  const now = new Date();
  const tanggal = now.toLocaleDateString('id-ID');
  const waktu = now.toLocaleTimeString('id-ID');

  const data = {
    embeds: [
      {
        title: "üì¶ Pengambilan Stok Barang",
        color: 5814783,
        fields: [
          { name: "üë§ Nama", value: getText("nama"), inline: true },
          { name: "üìã Penanggung Jawab", value: getText("penanggung"), inline: true },
          {
            name: "üì¶ Barang", value:
              `Pegagan: ${getVal("pegagan")}\n` +
              `Perban: ${getVal("perban")}\n` +
              `Painkiller: ${getVal("painkiller")}\n` +
              `Betadine: ${getVal("betadine")}\n` +
              `Zat Besi: ${getVal("zatbesi")}\n` +
              `Sayur Kol: ${getVal("sayurkol")}`,
            inline: false
          },
          { name: "üí∞ Total Harga", value: `Rp ${total.toLocaleString("id-ID")}`, inline: false },
          { name: "üïí Tanggal & Waktu", value: `${tanggal} - ${waktu}`, inline: false },
          { name: "üìù Keterangan", value: getText("keterangan"), inline: false }
        ],
        footer: { text: "Tabib Pulau - Cayo Perico" }
      }
    ]
  };

  await fetch("https://discord.com/api/webhooks/1364665385374191707/nBSRNthx10Qs9qDjoTn3DMObVqueld7ywxLBnz4DdopPiozCLzRcgjpu9eLH8K_yMvFV", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  document.querySelector("#customAlert .font-weight-700").textContent = "Data berhasil direkap!";
  document.querySelector("#customAlert .font-weight-normal").textContent = "Pengambilan stok kamu sudah masuk sistem.<br>Terima kasih üôè";
  showCustomAlert();
  document.getElementById("stockForm").reset();
  document.getElementById("totalHarga").textContent = "Total Harga: Rp 0";
  submitBtn.disabled = false;
  submitBtn.innerHTML = "Sikat üöÄ";
});

// --- MODAL CUSTOM ALERT ---
function showCustomAlert() {
  document.getElementById('customAlert').style.display = 'flex';
}
function hideCustomAlert() {
  document.getElementById('customAlert').style.display = 'none';
}
  </script>
</body>
</html>